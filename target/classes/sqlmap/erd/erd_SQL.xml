<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ipms.proj.erd.mapper.ErdMapper">

	<resultMap type="com.ipms.proj.erd.vo.ErdVO" id="erdVO">
		<result property="projId" column="proj_id" />
		<result property="memNum" column="mem_num" />
		<result property="erdVer" column="erd_ver" />
		<result property="erdTitle" column="erd_title" />
		<result property="erdProjData" column="erd_proj_data" javaType="java.lang.String" jdbcType="CLOB"/>
		<result property="deleteWhth" column="delete_whth" />
	</resultMap>

	<insert id="insertErd" parameterType="com.ipms.proj.erd.vo.ErdVO">
		<selectKey keyProperty="erdVer" order="BEFORE" resultType="int">
			select nvl(max(erd_ver),0)+1 from erd_proj
		</selectKey>
	
		INSERT INTO erd_proj ( 
		    erd_ver,
		    erd_title,
		    erd_proj_data
		) VALUES (
		    #{erdVer},
		    #{erdTitle},
		    #{erdProjData}
		)
	
	</insert>
	
	<select id="selectVer" parameterType="com.ipms.proj.erd.vo.ErdVO" resultMap="erdVO">
	SELECT
		erd_ver,
		erd_title
	FROM
		erd_proj
	where 
		DELETE_WHTH = 'n'	
	
	</select>
	
	<select id="selectErd" parameterType="com.ipms.proj.erd.vo.ErdVO" resultMap="erdVO">
		select 
		    erd_title,
		    erd_proj_data
		from 
			erd_proj
		where 
		<if test="erdVer == null">
			erd_ver = (select max(erd_ver) from erd_proj where DELETE_WHTH = 'n')
		</if>
		<if test="erdVer != null">
			erd_ver = #{erdVer}
		</if>
		and DELETE_WHTH = 'n'	
	</select>
	
	<update id="erdUpdate" parameterType="com.ipms.proj.erd.vo.ErdVO">
		UPDATE erd_proj
	    SET
	        erd_title = #{erdTitle},
	        erd_proj_data = #{erdProjData}
		WHERE
		    erd_ver =#{erdVer}

	</update>
	
	<update id="erdDelete" parameterType="com.ipms.proj.erd.vo.ErdVO">
		UPDATE erd_proj
    	SET
        	DELETE_WHTH = 'y'
		WHERE
			erd_ver =#{erdVer}
	</update>
</mapper>