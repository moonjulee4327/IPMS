<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ipms.proj.issue.mapper.IsuueMapper">
	<select id="taskListSelect" resultType="com.ipms.proj.issue.vo.IssueVO">
		SELECT TASK_ID , TASK_TITLE
		FROM TASK
		WHERE HIGH_TASK_ID IS NOT NULL
	</select>
	
	<insert id="IssueDataInsert" parameterType="com.ipms.proj.issue.vo.IssueVO" >
		<selectKey keyProperty="issueId" order="BEFORE" resultType="string">
			select  NVL(MAX(TO_NUMBER(ISSUE_ID))+1,1) as ISSUE_ID
        	from ISSUE
		</selectKey>
		
		INSERT INTO ISSUE(
			  ISSUE_ID
			, TASK_ID
			, ISSUE_TITLE
			, ISSUE_CTS
			, ISSUE_RGST_DATE
			, ISSUE_STUS_CODE
			, ITGRN_ATTACH_FILE_NUM
			, DELETE_YN
			, WRITER
			, PROJ_ID)
		VALUES(
			 #{issueId}
			,#{taskId}
			,#{issueTitle}
			,#{issueCts}
			,sysdate
			,'미해결'
			,#{itgrnAttachFileNum}
			,'n'
			, #{writer}
			, #{projId}
			)
	</insert>
	
	
	<select id="MaxFileNumSelect" resultType="int">
		SELECT MAX(INTG_ATTACH_FILE_NUM)+1 
		FROM INTG_ATTACH_FILE
	</select>

	<select id="IssueListSelect" resultType="com.ipms.proj.issue.vo.IssueVO">
		SELECT 
		 ISSUE_ID
		, TASK_ID
		, ISSUE_TITLE
		, ISSUE_CTS
		, TO_CHAR(TO_DATE(ISSUE_RGST_DATE,'YY-MM-DD'),'YYYY-MM-DD') AS ISSUE_RGST_DATE
		, ISSUE_STUS_CODE
		, ITGRN_ATTACH_FILE_NUM
		, DELETE_YN
		, WRITER
		FROM ISSUE
		ORDER BY TO_NUMBER(ISSUE_ID) ASC
	
	</select>
	
	
	<select id="issuePage" parameterType="com.ipms.commons.vo.Criteria" resultType="com.ipms.proj.issue.vo.IssueVO" >
		<![CDATA[
			SELECT 
              ISSUE_ID
              , TASK_ID
              , ISSUE_TITLE
              , ISSUE_CTS
              , ISSUE_RGST_DATE
              , ISSUE_STUS_CODE
              , ITGRN_ATTACH_FILE_NUM
              , DELETE_YN
              , WRITER
              , PROJ_ID
            FROM ( SELECT ROWNUM RN
                      , ISSUE_ID
                      , TASK_ID
                      , ISSUE_TITLE
                      , ISSUE_CTS
                      , ISSUE_RGST_DATE
                      , ISSUE_STUS_CODE
                      , ITGRN_ATTACH_FILE_NUM
                      , DELETE_YN
                      , WRITER
                      , PROJ_ID
                FROM( SELECT ISSUE_ID
	                      , TASK_ID
	                      , ISSUE_TITLE
	                      , ISSUE_CTS
	                      , ISSUE_RGST_DATE
	                      , ISSUE_STUS_CODE
	                      , ITGRN_ATTACH_FILE_NUM
	                      , DELETE_YN
	                      , WRITER
                          , PROJ_ID
                FROM ISSUE
                WHERE PROJ_ID = #{projId}
	                        ORDER BY  TO_NUMBER(ISSUE_ID) DESC ) A )
	            WHERE RN > ( #{pageNum} - 1 ) * #{amount} AND RN <= #{pageNum} * #{amount}
	            
            ]]>
		
	</select>
	
	<select id="totalNum" resultType="int">
		SELECT COUNT(ISSUE_ID)
		FROM ISSUE
		
	</select>
	
	<select id="IssueDetail" parameterType="com.ipms.proj.issue.vo.IssueVO" resultType="com.ipms.proj.issue.vo.IssueVO">
		SELECT ISSUE_ID
			, TASK_ID
			, ISSUE_TITLE
			, ISSUE_CTS
			, ISSUE_RGST_DATE
			, ISSUE_STUS_CODE
			, ITGRN_ATTACH_FILE_NUM
			, DELETE_YN, WRITER
                    , (
	                      SELECT  SAVE_FILE_NAME
	                      FROM INTG_ATTACH_FILE
	                      WHERE ITGRN_ATTACH_FILE_NUM = INTG_ATTACH_FILE_NUM
<!-- 	                      AND ATTACH_FILE_SEQ = 1 -->
                      ) AS FILE_PATH
                    , (
                      SELECT  FILE_NAME
                      FROM INTG_ATTACH_FILE
                      WHERE ITGRN_ATTACH_FILE_NUM = INTG_ATTACH_FILE_NUM
<!--                       AND ATTACH_FILE_SEQ = 1 -->
                      ) AS FILE_NAME
		FROM ISSUE
		WHERE ISSUE_TITLE =  TO_CHAR(#{issueTitle})
		AND PROJ_ID = #{projId}
	</select>
	
	<insert id="uploadFileInsert" parameterType="com.ipms.commons.ftp.vo.IntgAttachFileVO" >
		INSERT INTO INTG_ATTACH_FILE(
              INTG_ATTACH_FILE_NUM
            , ATTACH_FILE_SEQ
            , FILE_PATH
            , FILE_NAME
            , SAVE_FILE_NAME
            , FILE_SIZE
            , FILE_SIZE_NAME
            , RGST_DATE
            , RGST_ID
            , FILE_DELETE_YN
            , FILE_TYPE) 
     VALUES(	
           	   #{intgAttachFileNum}
               ,#{attachFileSeq}
			   ,#{filePath}
			   ,#{fileName}
			   ,#{saveFileName}
			   ,#{fileSize}
			   ,#{fileSizeName}
			   ,sysdate
			   ,'나다'
			   ,'n'
			   ,#{fileType}
		   )
	
	</insert>
	
	<select id="getMemCode" parameterType="string" resultType="string">
		SELECT MEM_CODE
		FROM MEM
		WHERE MEM_EMAIL =#{userName} 
	</select>
	
	<select id="getUserName" parameterType="string" resultType="string">
		SELECT MEM_NAME
		FROM MEM
		WHERE MEM_EMAIL =#{memName}
	</select>
	

</mapper>