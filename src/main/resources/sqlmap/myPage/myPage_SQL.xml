<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ipms.main.mypage.mapper.MyPageMapper">


    <!-- 신청한 회원 조회  com.ipms.main.mypage.mapper.MyPageMapper.memberWhoApplied-->
    <select id="memberWhoApplied" parameterType="com.ipms.main.newProject.vo.ProjMemVO"
            resultType="com.ipms.main.newProject.vo.ProjMemVO">
        <![CDATA[
        SELECT A.MEM_CODE, A.PROJ_ID
        FROM PROJ_MEM A
        WHERE A.MEM_CODE <> #{memCode}
          AND A.prtpt_aprov_code = 'N'
          AND A.PROJ_ID IN
              (SELECT B.PROJ_ID FROM MEMBER_AUTH B WHERE B.MEM_CODE = #{memCode} AND B.MEM_AUTH = 'ROLE_PROJECT_LEADER')
        ]]>
    </select>

    <!-- 신청한 프로젝트 com.ipms.main.mypage.mapper.MyPageMapper.projectsApplied-->
    <select id="projectsApplied" parameterType="com.ipms.main.newProject.vo.ProjMemVO"
            resultType="com.ipms.main.newProject.vo.ProjMemVO">
        SELECT A.MEM_CODE, A.PROJ_ID
        FROM PROJ_MEM A
        WHERE A.MEM_CODE = #{memCode}
          AND A.prtpt_aprov_code = 'N'
    </select>


    <select id="getCheckProjId" parameterType="string" resultType="com.ipms.main.newProject.vo.ProjVO">
        select proj_id
        from proj_mem
        where mem_code = (select mem_code from mem where mem_email = #{memEmail})
    </select>


    <select id="getMemCode" parameterType="string" resultType="string">
        select mem_code
        from mem
        where mem_email = #{memEmail}
    </select>

    <update id="approvalJoiningProject" parameterType="com.ipms.main.newProject.vo.ProjMemVO">
        UPDATE proj_mem
        SET prtpt_aprov_code = 'Y'
        WHERE mem_code = #{memCode}
          AND proj_id = #{projId}
          AND prtpt_aprov_code = 'N'
    </update>

    <update id="companionProject" parameterType="com.ipms.main.newProject.vo.ProjMemVO">
        UPDATE proj_mem
        SET prtpt_aprov_code = 'N',
            REFER_CTS='반려'
        WHERE mem_code = #{memCode}
          AND proj_id = #{projId}
          AND prtpt_aprov_code = 'Y'
          AND REFER_CTS = '0'
    </update>


    <select id="goingProjects" parameterType="com.ipms.main.newProject.vo.ProjMemVO"
            resultType="com.ipms.main.newProject.vo.ProjMemVO">
        SELECT DISTINCT(SELECT M.MEM_NAME
                        FROM MEM M
                        WHERE M.MEM_CODE IN (SELECT A.MEM_CODE
                                             FROM MEMBER_AUTH A
                                             WHERE A.MEM_AUTH = 'ROLE_PROJECT_LEADER'
                                               AND A.MEM_CODE = #{memCode})) as mem_name
                      , A.MEM_CODE
                      , A.PROJ_ID
                      ,(SELECT P.PROJ_NAME FROM PROJ P WHERE P.PROJ_ID = A.PROJ_ID) as proj_name
        FROM PROJ_MEM A
        WHERE A.MEM_CODE = #{memCode}
          AND A.prtpt_aprov_code = 'Y'
          AND A.DROPSTATUS = '0'
    </select>

    <select id="invitationWaitingList" parameterType="com.ipms.main.newProject.vo.ProjMemVO"
            resultType="com.ipms.main.newProject.vo.ProjMemVO">
        select DISTINCT I.mem_code, I.proj_Id , P.PROJ_NAME
        from INVITATION I , PROJ P
        where I.mem_code = #{memCode}
          AND I.invttnot ='1'
          AND P. MEM_CODE = #{memCode}
    </select>

    <!-- 마이페이지 초대신청 -> 초대된 프로젝트 승인-->
    <insert id="acceptInvitation" parameterType="com.ipms.main.newProject.vo.ProjMemVO">
        INSERT INTO proj_mem (
            mem_code,
            proj_id,
            PRTPT_APROV_CODE
        ) VALUES (
                     #{memCode},
                   #{projId},
                     'Y'
                 )
    </insert>
    <delete id="acceptInviteAndDelete" parameterType="com.ipms.main.newProject.vo.ProjMemVO">
        UPDATE invitation
        SET
            invttnot='0'
        WHERE
            mem_code = #{memCode}
          AND proj_id = #{projId}
          AND invttnot = '1'
    </delete>


    <!-- 마이페이지 초대신청 -> 초대된 프로젝트 거절-->
    <delete id="refusalInvitation" parameterType="com.ipms.main.newProject.vo.ProjMemVO">
        DELETE FROM invitation
        WHERE
            proj_id=#{projId}
          AND MEM_CODE =#{memCode}
    </delete>
</mapper>